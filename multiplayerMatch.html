<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic-Tac-Toe Game</title>
    <link rel="stylesheet" href="multiplayerMatchStyle.css">
</head>
<body>
    <div id="titleDiv">
        <h1 class="title">Tic-Tac-Toe</h1>
        <br>
        <input class = "options" id="backButton" type="button" value="Click me to Return to the Lobby!" onclick="returnToLobby()">
    </div>
    <div class="game">


        <div class="status">
            <h3>>Status: </h3>
            <div id="gameStatus"></div>
        </div>
        
        <div class="board">
            <div id="cell1" class="cell" onclick="placeMark(1)"></div>
            <div id="cell2" class="cell" onclick="placeMark(2)"></div>
            <div id="cell3" class="cell" onclick="placeMark(3)"></div>
            <div id="cell4" class="cell" onclick="placeMark(4)"></div>
            <div id="cell5" class="cell" onclick="placeMark(5)"></div>
            <div id="cell6" class="cell" onclick="placeMark(6)"></div>
            <div id="cell7" class="cell" onclick="placeMark(7)"></div>
            <div id="cell8" class="cell" onclick="placeMark(8)"></div>
            <div id="cell9" class="cell" onclick="placeMark(9)"></div>
        </div>
        <h3 class="createdBy">Created by: Juan | Bernando | Saul</h3>
    </div>


    <script>

        const ipAddr = "10.0.0.191";
        const port = "8765";
        const socket = new WebSocket("ws://" + ipAddr + ":" + port);

        // This is the client side of the game
        // Like who is current playing 
        const gameStatus = document.getElementById('gameStatus');
        // This is the board
        const cells = document.querySelectorAll('.cell');
        let player = null;


        // Redirects to Lobby
        function returnToLobby()
        {
            window.location.href = "index.html";

        }

        // Listens if the connection to the server is established
        socket.addEventListener('open', function (event) {
            gameStatus.textContent = 'Connected to the WebSocket server';
            socket.send(JSON.stringify({type:'beginMatch'}))
        });

        /* So something worth noting was that the client needed a way to block the player to make moves when it isnt their turn 
            therfore 2 functions were made, enableBoard(), disableBoard() */
        socket.addEventListener('message', function (event) {
            const data = JSON.parse(event.data);
            if (data.type === 'player') {
                player = data.player;
                gameStatus.textContent =  `${player}`;
            } else if (data.type === 'state') {
                updateBoard(data.state);
                // Enable or disable the board based on currentPlayer
                if ((data.state.currentPlayer === 'X' && player === 'p1') || 
                    (data.state.currentPlayer === 'O' && player === 'p2')) {
                    // It's this client's turn
                    enableBoard();
                } else {
                    // It's not this client's turn
                    disableBoard();
                }
            } else if (data.type === 'win') {
                alert(`Player ${data.player} won!`);
                // Disable the board after win
                disableBoard();
                // Optionally reset the game here
            } else if (data.type === 'error') {
                alert(data.message);
            }
        });

        // Enables board and allows for clicks
        function enableBoard() {
            cells.forEach(cell => {
                cell.style.pointerEvents = 'auto'; // Enable clicking
            });
        }

        // Disables board from being clicked
        function disableBoard() {
            cells.forEach(cell => {
                cell.style.pointerEvents = 'none'; // Disable clicking
            });
        }


        // Sends cellID to Server of which cell is being clicked
        function placeMark(cellId) {
            if (player) {
                socket.send(JSON.stringify({ cellId: cellId })); 
            }
        }

        // UPDATES THE BOARD
        function updateBoard(state) {
            //Clears all cells
            cells.forEach(cell => cell.textContent = '');
            // Place the marks for player1
            state.p1Moves.forEach(spot => {
                document.getElementById('cell' + spot).textContent = 'X';
            });
            // Place the marks for player2
            state.p2Moves.forEach(spot => {
                document.getElementById('cell' + spot).textContent = 'O';
            });
            // Update the current player status
            gameStatus.textContent = `Current player: ${state.currentPlayer}`;
        }
    </script>
</body>
</html>
